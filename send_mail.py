import os
import smtplib
import requests
from email.mime.text import MIMEText

GMAIL = os.environ["GMAIL_ADDRESS"]
PASSWORD = os.environ["GMAIL_APP_PASSWORD"]
MAIL_TO = os.environ["MAIL_TO"]
WORKER_URL = os.environ["WORKER_URL"]

res = requests.get(WORKER_URL, timeout=15)
res.raise_for_status()
data = res.json()

items = []
for task in data.get("tasks", []):
    items.append(f"""
      <li style="margin-bottom:12px;">
        <b>{task["title"]}</b><br>
        <a href="{task["url_do"]}">â–¶ Do</a> |
        <a href="{task["url_someday"]}">ğŸ•’ Someday</a> |
        <a href="{task["url_drop"]}">ğŸ—‘ Drop</a>
      </li>
    """)

html = f"""
<html>
<body style="font-family: sans-serif;">
  <h2>ğŸ“¥ ä»Šæ—¥ã®Inbox</h2>
  {"<ul>" + "".join(items) + "</ul>" if items else "<p>ä»Šæ—¥ã¯Inboxã‚¼ãƒ­ã§ã™ ğŸ‰</p>"}
  <hr>
  <p style="font-size:12px;color:#666;">Generated by GTD Morning Mail</p>
</body>
</html>
"""

msg = MIMEText(html, "html", "utf-8")
msg["Subject"] = f"ã€GTDã€‘ä»Šæ—¥ã®Inboxï¼ˆ{len(items)}ä»¶ï¼‰"
msg["From"] = GMAIL
msg["To"] = MAIL_TO

with smtplib.SMTP_SSL("smtp.gmail.com", 465) as smtp:
    smtp.login(GMAIL, PASSWORD)
    smtp.send_message(msg)

print("mail sent")
